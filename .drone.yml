---
kind: pipeline
name: unit-test

steps:
  - name: build
    image: gcr.io/wise-pub/wt-node-14@sha256:9dfd14c6f4fcb91aa950cadd0b03e34ca3af8d9df0f2b6c3b643d3d317fdc8d1
    commands:
      - make clean
      - make init
      - make lint
      - make build

  - name: node-server
    image: gcr.io/wise-pub/wt-node-14@sha256:9dfd14c6f4fcb91aa950cadd0b03e34ca3af8d9df0f2b6c3b643d3d317fdc8d1
    commands:
      - ./node_modules/.bin/ts-node src/test/integration/server/server.ts &
      - ENVOY_HOST='envoyproxy' make integration-test

services:
  - name: envoyproxy
    image: envoyproxy/envoy:v1.15.0
    commands:
      - envoy --config-path src/test/integration/envoy/envoy.yaml

trigger:
  event:
    - push

---
kind: pipeline
name: mirror-to-github
depends_on:
  - unit-test

steps:
  - name: github-push
    image: registry.dev.wisetime.com/git
    environment:
      GITHUB_SSH_KEY_B64:
        from_secret: github-ssh-key-b64
    commands:
      - scripts/mirror.sh
    when:
      ref:
        - refs/heads/master
        - refs/tags/*

trigger:
  event:
    - push
    - tag

---
kind: secret
name: git-ssh-key-b64
get:
  path: drone/stash/submodule-rsa
  name: submod-key-b64

---
kind: secret
name: github-ssh-key-b64
get:
  path: drone/publish/github/grpc-web-rx
  name: gh-grpc-web-rx-key-b64

# example local builds:
#  - drone exec --trusted --include test --branch feature/WT-7371-configuration-as-code
#  - drone exec --trusted --include trigger-bamboo-artifact-master-build --secret-file secrets.env --branch master
